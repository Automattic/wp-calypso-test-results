name: Add Label

on:
  issues:
    types: closed
    
jobs:
  add_label:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: Get comments
        uses: octokit/request-action@v2.x
        id: get_comments
        with:
          route: GET /repos/Automattic/wp-calypso-test-results/issues/${{ github.event.issue.number }}/comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          echo "LAST_COMMENT=$('${{ steps.get_comments.outputs.data }}' | tr -d '[:cntrl:]' | jq -r '.[-1].body')" >> "$GITHUB_ENV"

      - name: Show last comment
        run: |
          echo env.LAST_COMMENT
          
      - name: add label
        uses: actions-ecosystem/action-add-labels@v1
        if: ${{ contains(env.LAST_COMMENT, '([S|s]tale)+.*([C|c]losed)+') }}
        with:
          labels: wontfix
